pool:
  name: 'self-hosted-ado-agents'

trigger:
  branches:
    include:
    - main
  paths:
    include:
    - .cicd/docker/api
    - .cicd/ado/build-ai-r-core-api-multi-arch.yaml

pr: none

resources:
  repositories:
  - repository: platformops.dev
    type: github
    name: qbituniverse/platformops.dev
    endpoint: qbituniverse

stages:
- stage: DockerBuild
  displayName: 'Build Multi-Arch Docker Images for Api'
  variables:
    imageDockerfile: .cicd/docker/api/Dockerfile-ai-r-core-api
    imageRepository: qbituniverse/ai-r-core-api
    imageTag: $(imageVersion).$(Build.BuildId)
    imageVersion: 'N/A'
  jobs:
  - job: DockerBuild
    displayName: 'Build Multi-Arch Docker Images for Api'
    timeoutInMinutes: 0
    steps:
    - template: content/azure-devops/builds/assign-build-number.yaml@platformops.dev
      parameters:
        imageDockerfile: $(imageDockerfile)
        imageTag: $(imageTag)
    
    - template: content/azure-devops/builds/dockerhub-login.yaml@platformops.dev

    - template: content/azure-devops/builds/create-buildx.yaml@platformops.dev
      parameters:
        buildNumber: $(Build.BuildId)
    
    - template: content/azure-devops/builds/build-push-docker-image-multi-arch.yaml@platformops.dev
      parameters:
        imageDockerfile: $(imageDockerfile)
        imageRepository: $(imageRepository)
        imageTag: latest

    - template: content/azure-devops/builds/build-push-docker-image-multi-arch.yaml@platformops.dev
      parameters:
        imageDockerfile: $(imageDockerfile)
        imageRepository: $(imageRepository)
        imageTag: $(imageTag)

    - template: content/azure-devops/builds/build-push-docker-image-multi-arch.yaml@platformops.dev
      parameters:
        imageDockerfile: $(imageDockerfile)-java
        imageRepository: $(imageRepository)
        imageTag: $(imageTag)-java

    - template: content/azure-devops/builds/build-push-docker-image-multi-arch.yaml@platformops.dev
      parameters:
        imageDockerfile: $(imageDockerfile)-tidyverse
        imageRepository: $(imageRepository)
        imageTag: $(imageTag)-tidyverse

    - template: content/azure-devops/builds/delete-buildx.yaml@platformops.dev
      parameters:
        buildNumber: $(Build.BuildId)